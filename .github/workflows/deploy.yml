name: Deploy to Cloud Run

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

permissions:
  contents: read

env:
  # Default values; you can override these with GitHub Variables
  DOCKERHUB_REPO: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/studtasks
  GCP_REGION: ${{ vars.GCP_REGION || 'europe-west3' }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  SERVICE_NAME: ${{ vars.SERVICE_NAME }}
  PHX_HOST: ${{ vars.PHX_HOST }}

jobs:
  deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Derive short SHA
        id: vars
        shell: bash
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        shell: bash
        env:
          IMAGE: ${{ env.DOCKERHUB_REPO }}:${{ steps.vars.outputs.SHORT_SHA }}
        run: |
          echo "Building $IMAGE"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: "beta"

      - name: Deploy to Cloud Run
        shell: bash
        env:
          IMAGE: ${{ env.DOCKERHUB_REPO }}:${{ steps.vars.outputs.SHORT_SHA }}
        run: |
          if [[ -z "${SERVICE_NAME}" ]]; then
            echo "SERVICE_NAME variable is not set (Repository variable)." >&2
            exit 1
          fi
          if [[ -z "${PHX_HOST}" ]]; then
            echo "PHX_HOST variable is not set (Repository variable)." >&2
            exit 1
          fi
          if [[ -z "${GCP_PROJECT_ID}" ]]; then
            echo "GCP_PROJECT_ID variable is not set (Repository variable)." >&2
            exit 1
          fi

          gcloud run deploy "${SERVICE_NAME}" \
            --image "$IMAGE" \
            --region "${GCP_REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars PHX_HOST="${PHX_HOST}",PHX_SERVER=true \
            --set-env-vars POOL_SIZE=10 \
            --set-secrets SECRET_KEY_BASE=SECRET_KEY_BASE:latest,DATABASE_URL=DATABASE_URL:latest \
            --min-instances=0 --max-instances=5 \
            --concurrency=80

      - name: Output deployed revision
        shell: bash
        run: |
          gcloud run services describe "${SERVICE_NAME}" \
            --region "${GCP_REGION}" \
            --format 'value(status.latestReadyRevisionName)'
